-- Create Events Table
create table if not exists eventos_calendario (
  id uuid default uuid_generate_v4() primary key,
  empresa_id uuid references empresas(id) on delete cascade not null,
  titulo text not null,
  descripcion text,
  fecha timestamp with time zone not null,
  tipo text default 'general', -- 'general', 'cita', 'recordatorio'
  nombre_contacto text, -- Persona a quien recordar (opcional)
  telefono_contacto text, -- Para WhatsApp (opcional)
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- RLS Policies
alter table eventos_calendario enable row level security;

create policy "Empresas can view their own events"
  on eventos_calendario for select
  using (auth.uid() in (
    select owner_id from empresas where id = empresa_id
    union
    select id from perfiles where empresa_id = eventos_calendario.empresa_id
  ));

create policy "Empresas can insert their own events"
  on eventos_calendario for insert
  with check (auth.uid() in (
    select owner_id from empresas where id = empresa_id
    union
    select id from perfiles where empresa_id = eventos_calendario.empresa_id
  ));

create policy "Empresas can update their own events"
  on eventos_calendario for update
  using (auth.uid() in (
    select owner_id from empresas where id = empresa_id
    union
    select id from perfiles where empresa_id = eventos_calendario.empresa_id
  ));

create policy "Empresas can delete their own events"
  on eventos_calendario for delete
  using (auth.uid() in (
    select owner_id from empresas where id = empresa_id
    union
    select id from perfiles where empresa_id = eventos_calendario.empresa_id
  ));
